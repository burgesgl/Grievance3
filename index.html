<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grievance Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .nav-tab {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .nav-tab:hover {
            background: rgba(255,255,255,0.3);
        }

        .nav-tab.active {
            background: white;
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            padding: 30px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        label {
            font-weight: 600;
            color: #333;
        }

        select, input[type="text"], input[type="date"] {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-info {
            background: #06b6d4;
            color: white;
        }

        .btn-info:hover {
            background: #0891b2;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-edit {
            background: #f59e0b;
            color: white;
            padding: 6px 12px;
            font-size: 12px;
            margin-right: 5px;
        }

        .btn-edit:hover {
            background: #d97706;
        }

        .btn-view {
            background: #8b5cf6;
            color: white;
            padding: 6px 12px;
            font-size: 12px;
            margin-right: 5px;
        }

        .btn-view:hover {
            background: #7c3aed;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            padding: 20px;
            border-radius: 8px;
            color: white;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        .stat-total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-open { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .stat-resolved { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .stat-escalated { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        thead {
            background: #f8f9fa;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        tbody tr {
            transition: background-color 0.2s;
        }

        tbody tr:hover {
            background-color: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-filed { background: #dbeafe; color: #1e40af; }
        .status-investigation { background: #fef3c7; color: #92400e; }
        .status-mediation { background: #e0e7ff; color: #4338ca; }
        .status-arbitration { background: #fecaca; color: #991b1b; }
        .status-resolved { background: #d1fae5; color: #065f46; }
        .status-withdrawn { background: #f3f4f6; color: #374151; }

        .priority-high { color: #dc2626; font-weight: 600; }
        .priority-medium { color: #f59e0b; font-weight: 600; }
        .priority-low { color: #10b981; font-weight: 600; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .file-upload-area {
            border: 2px dashed #e0e0e0;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload-area:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .file-upload-area.dragover {
            border-color: #667eea;
            background: #eff6ff;
        }

        .file-list {
            margin-top: 10px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 5px;
        }

        .file-item-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-item-actions {
            display: flex;
            gap: 5px;
        }

        .file-item button {
            padding: 4px 8px;
            font-size: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .export-section {
            margin-left: auto;
        }

        .template-section {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .template-section h3 {
            color: #0369a1;
            margin-bottom: 10px;
        }

        .template-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .document-preview {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 20px;
            margin-top: 15px;
            font-family: 'Times New Roman', serif;
            line-height: 1.6;
        }

        .document-preview h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        .document-preview p {
            margin-bottom: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .attachment-badge {
            display: inline-block;
            background: #dbeafe;
            color: #1e40af;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 5px;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 10px 5px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìã Grievance Tracker</h1>
            <p class="subtitle">Manage and track workplace grievances</p>
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('grievances')">Grievances</button>
                <button class="nav-tab" onclick="switchTab('library')">Document Library</button>
                <button class="nav-tab" onclick="switchTab('journal')">Violation Journal</button>
            </div>
        </header>

        <div class="main-content">
            <!-- Grievances Tab -->
            <div id="tab-grievances" class="tab-content active">
            <div class="stats">
                <div class="stat-card stat-total">
                    <h3 id="stat-total">0</h3>
                    <p>Total Grievances</p>
                </div>
                <div class="stat-card stat-open">
                    <h3 id="stat-open">0</h3>
                    <p>Open Cases</p>
                </div>
                <div class="stat-card stat-resolved">
                    <h3 id="stat-resolved">0</h3>
                    <p>Resolved</p>
                </div>
                <div class="stat-card stat-escalated">
                    <h3 id="stat-escalated">0</h3>
                    <p>In Arbitration</p>
                </div>
            </div>

            <div class="controls">
                <button class="btn btn-primary" onclick="openModal()">+ New Grievance</button>
                <button class="btn btn-info" onclick="openTemplateManager()">üìÑ Manage Templates</button>
                
                <div class="filter-group">
                    <label for="statusFilter">Status:</label>
                    <select id="statusFilter" onchange="filterGrievances()">
                        <option value="all">All Statuses</option>
                        <option value="Filed">Filed</option>
                        <option value="Investigation">Investigation</option>
                        <option value="Mediation">Mediation</option>
                        <option value="Arbitration">Arbitration</option>
                        <option value="Resolved">Resolved</option>
                        <option value="Withdrawn">Withdrawn</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="priorityFilter">Priority:</label>
                    <select id="priorityFilter" onchange="filterGrievances()">
                        <option value="all">All Priorities</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="searchInput">Search:</label>
                    <input type="text" id="searchInput" placeholder="Search grievances..." oninput="filterGrievances()">
                </div>

                <div class="export-section">
                    <button class="btn btn-success" onclick="exportToCSV()">Export CSV</button>
                </div>
            </div>

            <div id="tableContainer">
                <table id="grievanceTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Date Filed</th>
                            <th>Grievant</th>
                            <th>Issue</th>
                            <th>Status</th>
                            <th>Priority</th>
                            <th>Files</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="grievanceBody">
                    </tbody>
                </table>
                <div id="emptyState" class="empty-state" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <h3>No Grievances Found</h3>
                    <p>Click "New Grievance" to add your first case</p>
                </div>
            </div>
            </div>
            <!-- End Grievances Tab -->

            <!-- Document Library Tab -->
            <div id="tab-library" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #667eea;">üìö Document Library</h2>
                <p style="margin-bottom: 20px; color: #666;">Store and manage your CBAs, MOUs, policies, and other contract documents.</p>

                <div class="controls">
                    <button class="btn btn-primary" onclick="openLibraryModal()">+ Add Document</button>
                    
                    <div class="filter-group">
                        <label for="libraryTypeFilter">Type:</label>
                        <select id="libraryTypeFilter" onchange="filterLibrary()">
                            <option value="all">All Types</option>
                            <option value="CBA">CBA</option>
                            <option value="MOU">MOU</option>
                            <option value="Policy">Policy</option>
                            <option value="Handbook">Handbook</option>
                            <option value="Letter">Letter/Memo</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="librarySearch">Search:</label>
                        <input type="text" id="librarySearch" placeholder="Search documents..." oninput="filterLibrary()">
                    </div>
                </div>

                <div id="libraryContainer"></div>
            </div>
            <!-- End Library Tab -->

            <!-- Violation Journal Tab -->
            <div id="tab-journal" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #667eea;">üìñ Violation Journal</h2>
                <p style="margin-bottom: 20px; color: #666;">Analyze patterns of contract violations and track resolution outcomes.</p>

                <div class="controls">
                    <button class="btn btn-primary" onclick="generateJournalReport()">Generate Report</button>
                    <button class="btn btn-success" onclick="exportJournalToPDF()">Export as PDF</button>
                </div>

                <div id="journalContent" style="margin-top: 30px;"></div>
            </div>
            <!-- End Journal Tab -->

        </div>
    </div>

    <!-- Grievance Modal -->
    <div id="grievanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add New Grievance</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <form id="grievanceForm" onsubmit="saveGrievance(event)">
                <input type="hidden" id="editId">
                
                <div class="template-section" style="background: #f0fdf4; border-color: #10b981; margin-bottom: 25px;">
                    <h3>ü§ñ Auto-Fill from Document (Start Here!)</h3>
                    <p style="margin-bottom: 10px; color: #666; font-size: 14px;"><strong>Have a completed grievance form?</strong> Upload it first and we'll automatically fill the fields below!</p>
                    <div class="file-upload-area" onclick="document.getElementById('extractFileInput').click()" style="background: white;">
                        <p>üìÑ Click to upload grievance document for auto-extraction</p>
                        <small>Best formats: TXT, PDF, DOCX</small>
                    </div>
                    <input type="file" id="extractFileInput" accept=".pdf,.docx,.doc,.txt,.png,.jpg,.jpeg" style="display: none;" onchange="handleExtractFile(event)">
                    <div id="extractStatus" style="margin-top: 10px; padding: 10px; border-radius: 6px; display: none;"></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="dateFiled">Date Filed</label>
                        <input type="date" id="dateFiled">
                    </div>

                    <div class="form-group">
                        <label for="grievant">Grievant Name</label>
                        <input type="text" id="grievant">
                    </div>
                </div>

                <div class="form-group">
                    <label for="issue">Issue/Violation</label>
                    <input type="text" id="issue" placeholder="e.g., Article 15 - Working Conditions">
                </div>

                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" placeholder="Brief description of the grievance..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select id="status">
                            <option value="Filed">Filed</option>
                            <option value="Investigation">Investigation</option>
                            <option value="Mediation">Mediation</option>
                            <option value="Arbitration">Arbitration</option>
                            <option value="Resolved">Resolved</option>
                            <option value="Withdrawn">Withdrawn</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="priority">Priority</label>
                        <select id="priority">
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="nextActionDate">Next Action Date</label>
                    <input type="date" id="nextActionDate">
                </div>

                <div class="form-group">
                    <label for="notes">Notes</label>
                    <textarea id="notes" placeholder="Additional notes, follow-ups, or action items..."></textarea>
                </div>

                <div class="template-section" style="background: #d1fae5; border-color: #10b981;">
                    <h3>‚úÖ Resolution Details</h3>
                    <p style="margin-bottom: 10px; color: #666; font-size: 14px;">Document how this grievance was resolved and the outcome.</p>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="resolutionDate">Resolution Date</label>
                        <input type="date" id="resolutionDate">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="resolutionMethod">Resolution Method</label>
                        <select id="resolutionMethod">
                            <option value="">Not yet resolved</option>
                            <option value="Level 1 Agreement">Level 1 Agreement</option>
                            <option value="Level 2 Agreement">Level 2 Agreement</option>
                            <option value="Level 3 Agreement">Level 3 Agreement</option>
                            <option value="Mediation Agreement">Mediation Agreement</option>
                            <option value="Arbitration Award">Arbitration Award</option>
                            <option value="Settlement">Settlement</option>
                            <option value="Withdrawn">Withdrawn</option>
                            <option value="Denied">Denied</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="resolutionSummary">Resolution Summary</label>
                        <textarea id="resolutionSummary" placeholder="Describe the outcome, agreed upon remedy, and any follow-up actions required..." style="min-height: 100px;"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Resolution Documents</label>
                        <div class="file-upload-area" id="resolutionFileUploadArea" onclick="document.getElementById('resolutionFileInput').click()">
                            <p>üìÑ Upload resolution documentation</p>
                            <small>Decision letters, settlement agreements, etc.</small>
                        </div>
                        <input type="file" id="resolutionFileInput" multiple style="display: none;" onchange="handleResolutionFileSelect(event)">
                        <div class="file-list" id="resolutionFileList"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Update Log (Track Changes)</label>
                    <div style="margin-bottom: 10px;">
                        <button type="button" class="btn btn-info" onclick="addUpdateEntry()">+ Add Update Entry</button>
                    </div>
                    <div id="updateLogArea" style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 6px; padding: 15px; max-height: 300px; overflow-y: auto;">
                        <div id="activityLogList"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Attachments</label>
                    <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('fileInput').click()">
                        <p>üìé Click or drag files here to upload</p>
                        <small>Supported: PDF, Word, Images, Text files</small>
                    </div>
                    <input type="file" id="fileInput" multiple style="display: none;" onchange="handleFileSelect(event)">
                    <div class="file-list" id="fileList"></div>
                </div>

                <div class="template-section">
                    <h3>üìù Generate Document from Template</h3>
                    <p style="margin-bottom: 10px; color: #666; font-size: 14px;">Generate a pre-filled document. Documents are generated as .txt files - you can copy/paste the content into Microsoft Word to save as .docx format.</p>
                    <div class="template-buttons">
                        <button type="button" class="btn btn-info" onclick="generateDocument('basic')">Basic Grievance Form</button>
                        <button type="button" class="btn btn-info" onclick="generateDocument('formal')">Formal Grievance Letter</button>
                        <button type="button" class="btn btn-info" onclick="generateDocument('appeal')">Appeal Form</button>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="closeModal()" style="background: #e5e7eb; color: #374151;">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Grievance</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Template Manager Modal -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Template Manager</h2>
                <button class="close-btn" onclick="closeTemplateModal()">&times;</button>
            </div>
            
            <div class="template-section">
                <h3>Upload Custom Template</h3>
                <p style="margin-bottom: 10px; color: #666;">Upload a Word document (.docx) with placeholders: {{grievant}}, {{dateFiled}}, {{issue}}, {{description}}, {{status}}, {{priority}}, {{notes}}</p>
                <input type="file" id="templateUpload" accept=".docx" onchange="handleTemplateUpload(event)">
            </div>

            <div style="margin-top: 20px;">
                <h3>Available Templates</h3>
                <div id="templateList" class="file-list"></div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-primary" onclick="closeTemplateModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Library Document Modal -->
    <div id="libraryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="libraryModalTitle">Add Document to Library</h2>
                <button class="close-btn" onclick="closeLibraryModal()">&times;</button>
            </div>
            <form id="libraryForm" onsubmit="saveLibraryDocument(event)">
                <input type="hidden" id="libraryEditId">
                
                <div class="form-group">
                    <label for="libraryDocType">Document Type *</label>
                    <select id="libraryDocType" required>
                        <option value="CBA">Collective Bargaining Agreement (CBA)</option>
                        <option value="MOU">Memorandum of Understanding (MOU)</option>
                        <option value="Policy">District Policy</option>
                        <option value="Handbook">Employee Handbook</option>
                        <option value="Letter">Letter/Memo</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="libraryDocName">Document Name *</label>
                    <input type="text" id="libraryDocName" placeholder="e.g., SEA-SPS CBA 2023-2026" required>
                </div>

                <div class="form-group">
                    <label for="libraryDocDate">Effective Date</label>
                    <input type="date" id="libraryDocDate">
                </div>

                <div class="form-group">
                    <label for="libraryDocArticles">Key Articles/Sections</label>
                    <textarea id="libraryDocArticles" placeholder="List key articles, e.g., Article 6.B - SCDM, Article 8.M - ETL Support"></textarea>
                </div>

                <div class="form-group">
                    <label for="libraryDocNotes">Notes</label>
                    <textarea id="libraryDocNotes" placeholder="Additional information about this document"></textarea>
                </div>

                <div class="form-group">
                    <label>Upload Document File *</label>
                    <div class="file-upload-area" onclick="document.getElementById('libraryDocFile').click()">
                        <p>üìÑ Click to upload document</p>
                        <small>PDF, Word, or text format</small>
                    </div>
                    <input type="file" id="libraryDocFile" style="display: none;" onchange="handleLibraryFileSelect(event)">
                    <div id="libraryFilePreview"></div>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="closeLibraryModal()" style="background: #e5e7eb; color: #374151;">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Document</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let grievances = [];
        let nextId = 1;
        let currentFiles = [];
        let currentResolutionFiles = [];
        let templates = [];
        let currentActivityLog = [];
        let libraryDocuments = [];
        let libraryNextId = 1;
        let currentLibraryFile = null;

        // Preloaded grievances with activity logs
        const preloadedGrievances = [
            {
                id: 1,
                dateFiled: '2024-12-09',
                grievant: 'SCDM Team at STEM',
                issue: 'Article 6.B - SCDM Meeting Initiation',
                description: 'Level 1 Grievance filed regarding STEM\'s SCDM team and its initiation. The employer refused to collaborate with the SCDM team to schedule or convene any SCDM meetings for the 2025-2026 school year.',
                status: 'Resolved',
                priority: 'High',
                nextActionDate: '',
                notes: 'Filed 12/9/2024. Level 1 meeting held 12/13/2024. Resolved 12/20/2024 - Principal Williams confirmed meeting scheduled upon return to school with SCDM members. Filed by Lee Burgess. Position: SCDM Chair. Worksite: STEM Middle Academy.',
                files: [],
                activityLog: [
                    { date: '2024-12-09', action: 'Grievance created', details: 'Initial filing' },
                    { date: '2024-12-13', action: 'Status changed to Investigation', details: 'Level 1 meeting held' },
                    { date: '2024-12-20', action: 'Status changed to Resolved', details: 'Principal Williams confirmed meeting scheduled' }
                ]
            },
            {
                id: 2,
                dateFiled: '2025-10-12',
                grievant: 'Adam Ericksen (ETL)',
                issue: 'Article 8.M - Clerical Support for ETL',
                description: 'The union charges that the employer violated Article 8.M of the CBA by not providing the ETL with seven hours a week of clerical support. Despite several attempts to communicate with Principal Andrea Williams, the Principal has not provided 7 hours per week of clerical support to ETL Adam Ericksen.',
                status: 'Resolved',
                priority: 'Medium',
                nextActionDate: '',
                notes: 'Remedy Sought: (1) Access to clerical support for seven hours per week to assist with scheduling IEP meetings and contacting families; (2) Time to train any clerical support provided; (3) Clerical support with proper access to SPS databases for scheduling and logging parent communications. Level Three hearing held 10/14/2025. District agreed to provide seven hours per week of clerical support to ETL Adam Ericksen. Decision letter dated 10/15/2025 from Valerie Williams, Chief of Human Resources. Filed by Lee Burgess, STEM SEA Building Representative. Present at hearing: Mike Przybylek (Union Rep), Lee Burgess, Adam Ericksen (ETL), Valerie Williams (HR Chief).',
                files: [],
                activityLog: [
                    { date: '2025-10-12', action: 'Grievance created', details: 'Initial filing' },
                    { date: '2025-10-14', action: 'Status changed to Investigation', details: 'Level Three hearing held' },
                    { date: '2025-10-15', action: 'Status changed to Resolved', details: 'District agreed to provide clerical support' }
                ]
            },
            {
                id: 3,
                dateFiled: '2025-11-06',
                grievant: 'SCDM Team at STEM',
                issue: 'Article 6.B - SCDM Meeting Violations',
                description: 'The union charges that the employer, through its agents, violated the Agreement Between the Springfield School Committee and the Springfield Education Association generally and specifically, including but not limited to, Article 6.B, when the employer, through its agents, refused to collaborate with the SCDM team to schedule or convene any SCDM meetings for the 2025-2026 school year.',
                status: 'Investigation',
                priority: 'High',
                nextActionDate: '',
                notes: 'Remedy Sought: Immediate scheduling and convening of the first SCDM meeting within five (5) school days of the determination of this grievance. Establish a regular monthly SCDM meeting schedule that meets the minimum requirement of two (2) meetings per month. Filed by Lee Burgess, Association Representative. Incident Date: 11/3/2025. Position: Unit A members. Worksite: STEM Middle School. Step 2.',
                files: [],
                activityLog: [
                    { date: '2025-11-06', action: 'Grievance created', details: 'Initial filing - Step 2' }
                ]
            }
        ];

        function loadData() {
            const saved = localStorage.getItem('grievances');
            
            if (saved) {
                const parsedGrievances = JSON.parse(saved);
                // If there are saved grievances, use them
                if (parsedGrievances.length > 0) {
                    grievances = parsedGrievances;
                    nextId = Math.max(...grievances.map(g => g.id), 0) + 1;
                } else {
                    // If saved but empty, load preloaded data
                    grievances = preloadedGrievances;
                    nextId = preloadedGrievances.length + 1;
                    saveData();
                }
            } else {
                // First time loading - use preloaded data
                grievances = preloadedGrievances;
                nextId = preloadedGrievances.length + 1;
                saveData();
            }
            
            const savedTemplates = localStorage.getItem('templates');
            if (savedTemplates) {
                templates = JSON.parse(savedTemplates);
            }
            
            renderGrievances();
            updateStats();
        }

        function saveData() {
            localStorage.setItem('grievances', JSON.stringify(grievances));
            localStorage.setItem('templates', JSON.stringify(templates));
        }

        function openModal(id = null) {
            const modal = document.getElementById('grievanceModal');
            const form = document.getElementById('grievanceForm');
            const modalTitle = document.getElementById('modalTitle');
            
            form.reset();
            currentFiles = [];
            currentResolutionFiles = [];
            currentActivityLog = [];
            document.getElementById('fileList').innerHTML = '';
            document.getElementById('resolutionFileList').innerHTML = '';
            document.getElementById('activityLogList').innerHTML = '';
            
            if (id !== null) {
                const grievance = grievances.find(g => g.id === id);
                if (grievance) {
                    modalTitle.textContent = 'Edit Grievance';
                    document.getElementById('editId').value = grievance.id;
                    document.getElementById('dateFiled').value = grievance.dateFiled;
                    document.getElementById('grievant').value = grievance.grievant;
                    document.getElementById('issue').value = grievance.issue;
                    document.getElementById('description').value = grievance.description || '';
                    document.getElementById('status').value = grievance.status;
                    document.getElementById('priority').value = grievance.priority;
                    document.getElementById('nextActionDate').value = grievance.nextActionDate || '';
                    document.getElementById('notes').value = grievance.notes || '';
                    
                    // Resolution fields
                    document.getElementById('resolutionDate').value = grievance.resolutionDate || '';
                    document.getElementById('resolutionMethod').value = grievance.resolutionMethod || '';
                    document.getElementById('resolutionSummary').value = grievance.resolutionSummary || '';
                    
                    if (grievance.files && grievance.files.length > 0) {
                        currentFiles = [...grievance.files];
                        renderFileList();
                    }
                    
                    if (grievance.resolutionFiles && grievance.resolutionFiles.length > 0) {
                        currentResolutionFiles = [...grievance.resolutionFiles];
                        renderResolutionFileList();
                    }
                    
                    if (grievance.activityLog && grievance.activityLog.length > 0) {
                        currentActivityLog = [...grievance.activityLog];
                        renderActivityLog();
                    }
                }
            } else {
                modalTitle.textContent = 'Add New Grievance';
                document.getElementById('dateFiled').valueAsDate = new Date();
            }
            
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('grievanceModal').classList.remove('active');
        }

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentFiles.push({
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result
                    });
                    renderFileList();
                };
                reader.readAsDataURL(file);
            });
        }

        function handleResolutionFileSelect(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentResolutionFiles.push({
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result
                    });
                    renderResolutionFileList();
                };
                reader.readAsDataURL(file);
            });
        }

        function renderResolutionFileList() {
            const fileList = document.getElementById('resolutionFileList');
            if (currentResolutionFiles.length === 0) {
                fileList.innerHTML = '';
                return;
            }
            
            fileList.innerHTML = currentResolutionFiles.map((file, index) => `
                <div class="file-item">
                    <span class="file-item-name">üìÑ ${file.name} (${formatFileSize(file.size)})</span>
                    <div class="file-item-actions">
                        <button type="button" class="btn btn-info" onclick="downloadResolutionFile(${index})">Download</button>
                        <button type="button" class="btn btn-danger" onclick="removeResolutionFile(${index})">Remove</button>
                    </div>
                </div>
            `).join('');
        }

        function removeResolutionFile(index) {
            currentResolutionFiles.splice(index, 1);
            renderResolutionFileList();
        }

        function downloadResolutionFile(index) {
            const file = currentResolutionFiles[index];
            const link = document.createElement('a');
            link.href = file.data;
            link.download = file.name;
            link.click();
        }

        async function handleExtractFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const statusDiv = document.getElementById('extractStatus');
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#dbeafe';
            statusDiv.style.color = '#1e40af';
            statusDiv.innerHTML = 'üîÑ Extracting data from document...';

            try {
                let extractedText = '';

                if (file.type === 'text/plain') {
                    extractedText = await file.text();
                } else if (file.type === 'application/pdf') {
                    extractedText = await extractFromPDF(file);
                } else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || 
                           file.type === 'application/msword') {
                    extractedText = await extractFromWord(file);
                } else if (file.type.startsWith('image/')) {
                    statusDiv.style.background = '#fef3c7';
                    statusDiv.style.color = '#92400e';
                    statusDiv.innerHTML = '‚ö†Ô∏è Images require OCR. For best results, please save your document as .txt or .docx and upload again.';
                    setTimeout(() => { statusDiv.style.display = 'none'; }, 8000);
                    return;
                } else {
                    extractedText = await file.text();
                }

                console.log('Extracted text:', extractedText.substring(0, 500)); // Debug log

                // Parse the extracted text and fill form fields
                parseAndFillForm(extractedText);

                statusDiv.style.background = '#d1fae5';
                statusDiv.style.color = '#065f46';
                statusDiv.innerHTML = '‚úÖ Data extracted successfully! Review the fields below and adjust as needed.';

                // Also add the file to attachments
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentFiles.push({
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result
                    });
                    renderFileList();
                };
                reader.readAsDataURL(file);

                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 10000);

            } catch (error) {
                console.error('Extraction error:', error);
                statusDiv.style.background = '#fee2e2';
                statusDiv.style.color = '#991b1b';
                statusDiv.innerHTML = '‚ö†Ô∏è Could not extract data. Try saving your document as a .txt file for best results.';
                setTimeout(() => { statusDiv.style.display = 'none'; }, 8000);
            }
        }

        async function extractFromPDF(file) {
            // For PDFs, we'll read as text and extract what we can
            const reader = new FileReader();
            return new Promise((resolve, reject) => {
                reader.onload = function(e) {
                    const text = e.target.result;
                    resolve(text);
                };
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        async function extractFromWord(file) {
            // For Word docs, read as text
            const reader = new FileReader();
            return new Promise((resolve, reject) => {
                reader.onload = function(e) {
                    const text = e.target.result;
                    resolve(text);
                };
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        async function extractFromImage(file) {
            // For images, inform user to use text format
            return new Promise((resolve) => {
                resolve("For best results with auto-extraction, please use PDF, Word (.docx), or plain text (.txt) format. Images require OCR which is not yet supported.");
            });
        }

        function parseAndFillForm(text) {
            // Extract date filed
            const datePatterns = [
                /Date of filing:?\s*(\d{1,2}\/\d{1,2}\/\d{4})/i,
                /Date Filed:?\s*(\d{1,2}\/\d{1,2}\/\d{4})/i,
                /Filed:?\s*(\d{1,2}\/\d{1,2}\/\d{4})/i
            ];
            for (const pattern of datePatterns) {
                const match = text.match(pattern);
                if (match) {
                    const [month, day, year] = match[1].split('/');
                    const isoDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    document.getElementById('dateFiled').value = isoDate;
                    break;
                }
            }

            // Extract grievant
            const grievantPatterns = [
                /Grievant:?\s*([^\n\t]+?)(?:\t|\n|Position:|School:)/i,
                /Grievant Name:?\s*([^\n\t]+?)(?:\t|\n|Position:|School:)/i,
            ];
            for (const pattern of grievantPatterns) {
                const match = text.match(pattern);
                if (match) {
                    document.getElementById('grievant').value = match[1].trim();
                    break;
                }
            }

            // Extract issue/article violation
            const issuePatterns = [
                /Article\s+([\d.A-Z]+)[^\n]*?[-‚Äì‚Äî]?\s*([^\n]+)/i,
                /Issue:?\s*([^\n]+)/i,
                /Violation:?\s*([^\n]+)/i,
                /Contract Violation:?\s*([^\n]+)/i
            ];
            for (const pattern of issuePatterns) {
                const match = text.match(pattern);
                if (match) {
                    if (match[2]) {
                        document.getElementById('issue').value = `Article ${match[1]} - ${match[2].trim()}`;
                    } else {
                        document.getElementById('issue').value = match[1].trim();
                    }
                    break;
                }
            }

            // Extract description/nature of grievance
            const descriptionPatterns = [
                /Nature of Grievance:?\s*\n\s*(.+?)(?:\n\s*Remedy|$)/is,
                /Description:?\s*\n\s*(.+?)(?:\n\s*Remedy|$)/is,
                /union charges that(.+?)(?:\n\s*Remedy|$)/is
            ];
            for (const pattern of descriptionPatterns) {
                const match = text.match(pattern);
                if (match) {
                    document.getElementById('description').value = match[1].trim().replace(/\s+/g, ' ');
                    break;
                }
            }

            // Extract remedy sought
            const remedyPatterns = [
                /Remedy Sought:?\s*\n\s*(.+?)(?:\n\s*Filed by|$)/is,
                /Relief Sought:?\s*\n\s*(.+?)(?:\n\s*Filed by|$)/is
            ];
            for (const pattern of remedyPatterns) {
                const match = text.match(pattern);
                if (match) {
                    const currentNotes = document.getElementById('notes').value;
                    const remedyText = 'Remedy Sought: ' + match[1].trim().replace(/\s+/g, ' ');
                    document.getElementById('notes').value = currentNotes ? currentNotes + '\n\n' + remedyText : remedyText;
                    break;
                }
            }

            // Extract incident date
            const incidentPatterns = [
                /Date of incident[^:]*:?\s*(\d{1,2}\/\d{1,2}\/\d{4})/i,
                /incident[^:]*date[^:]*:?\s*(\d{1,2}\/\d{1,2}\/\d{4})/i,
                /first knowledge[^:]*:?\s*(\d{1,2}\/\d{1,2}\/\d{4})/i
            ];
            for (const pattern of incidentPatterns) {
                const match = text.match(pattern);
                if (match) {
                    const currentNotes = document.getElementById('notes').value;
                    const incidentNote = 'Incident Date: ' + match[1];
                    if (!currentNotes.includes('Incident Date:')) {
                        document.getElementById('notes').value = currentNotes ? currentNotes + '\n' + incidentNote : incidentNote;
                    }
                    break;
                }
            }

            // Extract position
            const positionMatch = text.match(/Position:?\s*([^\n\t]+?)(?:\t|\n|School:)/i);
            if (positionMatch) {
                const currentNotes = document.getElementById('notes').value;
                const positionNote = 'Position: ' + positionMatch[1].trim();
                if (!currentNotes.includes('Position:')) {
                    document.getElementById('notes').value = currentNotes ? currentNotes + '\n' + positionNote : positionNote;
                }
            }

            // Extract worksite/school
            const worksiteMatch = text.match(/(?:School|Worksite):?\s*([^\n]+)/i);
            if (worksiteMatch) {
                const currentNotes = document.getElementById('notes').value;
                const worksiteNote = 'Worksite: ' + worksiteMatch[1].trim();
                if (!currentNotes.includes('Worksite:')) {
                    document.getElementById('notes').value = currentNotes ? currentNotes + '\n' + worksiteNote : worksiteNote;
                }
            }

            // Extract filed by
            const filedByMatch = text.match(/Filed by\s+([^,\n]+)/i);
            if (filedByMatch) {
                const currentNotes = document.getElementById('notes').value;
                const filedByNote = 'Filed by: ' + filedByMatch[1].trim();
                if (!currentNotes.includes('Filed by:')) {
                    document.getElementById('notes').value = currentNotes ? currentNotes + '\n' + filedByNote : filedByNote;
                }
            }

            // Smart status detection
            if (text.toLowerCase().includes('resolved') || text.toLowerCase().includes('agreed to provide')) {
                document.getElementById('status').value = 'Resolved';
            } else if (text.toLowerCase().includes('arbitration')) {
                document.getElementById('status').value = 'Arbitration';
            } else if (text.toLowerCase().includes('mediation')) {
                document.getElementById('status').value = 'Mediation';
            } else if (text.toLowerCase().includes('level three') || text.toLowerCase().includes('level 3')) {
                document.getElementById('status').value = 'Investigation';
            } else if (text.toLowerCase().includes('step 2') || text.toLowerCase().includes('level 2')) {
                document.getElementById('status').value = 'Investigation';
            } else {
                document.getElementById('status').value = 'Filed';
            }

            // Smart priority detection
            if (text.toLowerCase().includes('immediate') || 
                text.toLowerCase().includes('urgent') ||
                text.toLowerCase().includes('within five') ||
                text.toLowerCase().includes('refused')) {
                document.getElementById('priority').value = 'High';
            } else {
                document.getElementById('priority').value = 'Medium';
            }
        }

        function renderFileList() {
            const fileList = document.getElementById('fileList');
            if (currentFiles.length === 0) {
                fileList.innerHTML = '';
                return;
            }
            
            fileList.innerHTML = currentFiles.map((file, index) => `
                <div class="file-item">
                    <span class="file-item-name">üìé ${file.name} (${formatFileSize(file.size)})</span>
                    <div class="file-item-actions">
                        <button type="button" class="btn btn-info" onclick="downloadFile(${index})">Download</button>
                        <button type="button" class="btn btn-danger" onclick="removeFile(${index})">Remove</button>
                    </div>
                </div>
            `).join('');
        }

        function removeFile(index) {
            currentFiles.splice(index, 1);
            renderFileList();
        }

        function downloadFile(index) {
            const file = currentFiles[index];
            const link = document.createElement('a');
            link.href = file.data;
            link.download = file.name;
            link.click();
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Drag and drop functionality
        const fileUploadArea = document.getElementById('fileUploadArea');
        
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        });

        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('dragover');
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentFiles.push({
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result
                    });
                    renderFileList();
                };
                reader.readAsDataURL(file);
            });
        });

        function saveGrievance(event) {
            event.preventDefault();
            
            const editId = document.getElementById('editId').value;
            const isEditing = !!editId;
            
            const newGrievance = {
                id: editId ? parseInt(editId) : nextId++,
                dateFiled: document.getElementById('dateFiled').value,
                grievant: document.getElementById('grievant').value,
                issue: document.getElementById('issue').value,
                description: document.getElementById('description').value,
                status: document.getElementById('status').value,
                priority: document.getElementById('priority').value,
                nextActionDate: document.getElementById('nextActionDate').value,
                notes: document.getElementById('notes').value,
                resolutionDate: document.getElementById('resolutionDate').value,
                resolutionMethod: document.getElementById('resolutionMethod').value,
                resolutionSummary: document.getElementById('resolutionSummary').value,
                files: currentFiles,
                resolutionFiles: currentResolutionFiles,
                activityLog: currentActivityLog.length > 0 ? currentActivityLog : [
                    { date: new Date().toISOString().split('T')[0], action: 'Grievance created', details: 'Initial filing' }
                ]
            };

            if (isEditing) {
                const index = grievances.findIndex(g => g.id === parseInt(editId));
                const oldGrievance = grievances[index];
                
                // Track changes
                const today = new Date().toISOString().split('T')[0];
                
                if (oldGrievance.status !== newGrievance.status) {
                    newGrievance.activityLog.push({
                        date: today,
                        action: `Status changed from ${oldGrievance.status} to ${newGrievance.status}`,
                        details: 'Status updated'
                    });
                }
                
                if (oldGrievance.priority !== newGrievance.priority) {
                    newGrievance.activityLog.push({
                        date: today,
                        action: `Priority changed from ${oldGrievance.priority} to ${newGrievance.priority}`,
                        details: 'Priority updated'
                    });
                }
                
                if (newGrievance.files.length > oldGrievance.files.length) {
                    const numAdded = newGrievance.files.length - oldGrievance.files.length;
                    newGrievance.activityLog.push({
                        date: today,
                        action: `${numAdded} file(s) added`,
                        details: 'Documentation updated'
                    });
                }
                
                // Track resolution changes
                if (!oldGrievance.resolutionDate && newGrievance.resolutionDate) {
                    newGrievance.activityLog.push({
                        date: today,
                        action: 'Resolution documented',
                        details: `Resolved via ${newGrievance.resolutionMethod || 'agreement'}`
                    });
                }
                
                if (newGrievance.resolutionFiles.length > (oldGrievance.resolutionFiles?.length || 0)) {
                    const numAdded = newGrievance.resolutionFiles.length - (oldGrievance.resolutionFiles?.length || 0);
                    newGrievance.activityLog.push({
                        date: today,
                        action: `${numAdded} resolution document(s) added`,
                        details: 'Resolution documentation updated'
                    });
                }
                
                grievances[index] = newGrievance;
            } else {
                grievances.push(newGrievance);
            }

            saveData();
            renderGrievances();
            updateStats();
            closeModal();
        }

        function addUpdateEntry() {
            const updateText = prompt('Enter update details (e.g., "Met with principal", "Hearing scheduled for 12/15"):');
            if (updateText && updateText.trim()) {
                const today = new Date().toISOString().split('T')[0];
                currentActivityLog.push({
                    date: today,
                    action: 'Update added',
                    details: updateText.trim()
                });
                renderActivityLog();
            }
        }

        function renderActivityLog() {
            const logList = document.getElementById('activityLogList');
            if (currentActivityLog.length === 0) {
                logList.innerHTML = '<p style="color: #666; font-style: italic;">No updates yet. Changes will be tracked automatically.</p>';
                return;
            }
            
            logList.innerHTML = currentActivityLog.map((entry, index) => `
                <div style="padding: 10px; background: white; border-radius: 4px; margin-bottom: 8px; border-left: 3px solid #667eea;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #333;">${entry.action}</div>
                            <div style="color: #666; font-size: 14px; margin-top: 4px;">${entry.details}</div>
                        </div>
                        <div style="color: #999; font-size: 12px; white-space: nowrap; margin-left: 10px;">${formatDate(entry.date)}</div>
                    </div>
                </div>
            `).reverse().join('');
        }

        function generateSummary() {
            const grievant = document.getElementById('grievant').value;
            const issue = document.getElementById('issue').value;
            const description = document.getElementById('description').value;
            const status = document.getElementById('status').value;
            const notes = document.getElementById('notes').value;
            const priority = document.getElementById('priority').value;
            
            if (!grievant || !issue) {
                alert('Please fill in at least the Grievant and Issue fields to generate a summary.');
                return;
            }
            
            const summaryDiv = document.getElementById('summaryOutput');
            summaryDiv.style.display = 'block';
            summaryDiv.innerHTML = '<p style="color: #666;">üîÑ Analyzing grievance data...</p>';
            
            // Generate summary
            setTimeout(() => {
                summaryDiv.innerHTML = generateSummaryContent(grievant, issue, description, status, notes, priority, null);
            }, 500);
        }

        function generateSummaryForView(grievanceId) {
            const grievance = grievances.find(g => g.id === grievanceId);
            if (!grievance) return;
            
            const summaryDiv = document.getElementById(`viewSummaryOutput-${grievanceId}`);
            summaryDiv.style.display = 'block';
            summaryDiv.innerHTML = '<p style="color: #666;">üîÑ Analyzing grievance data...</p>';
            
            // Generate summary
            setTimeout(() => {
                summaryDiv.innerHTML = generateSummaryContent(
                    grievance.grievant,
                    grievance.issue,
                    grievance.description,
                    grievance.status,
                    grievance.notes,
                    grievance.priority,
                    grievance
                );
            }, 500);
        }

        function generateSummaryContent(grievant, issue, description, status, notes, priority, grievance) {
            let summary = `<h4 style="margin-bottom: 10px; color: #667eea;">üìä Grievance Summary</h4>`;
            summary += `<p style="margin-bottom: 10px;"><strong>Case:</strong> ${issue} filed on behalf of ${grievant}</p>`;
            summary += `<p style="margin-bottom: 10px;"><strong>Current Status:</strong> ${status} (${priority} Priority)</p>`;
            
            // If resolved, show resolution info
            if (grievance && grievance.resolutionMethod) {
                summary += `<p style="margin-bottom: 10px;"><strong>Resolution:</strong> ${grievance.resolutionMethod}`;
                if (grievance.resolutionDate) {
                    summary += ` on ${formatDate(grievance.resolutionDate)}`;
                }
                summary += `</p>`;
            }
            
            // Extract key points
            summary += `<h4 style="margin-top: 15px; margin-bottom: 10px; color: #667eea;">üéØ Key Points</h4><ul style="margin-left: 20px;">`;
            
            if (description) {
                const sentences = description.split('.').filter(s => s.trim().length > 20);
                sentences.slice(0, 3).forEach(sentence => {
                    summary += `<li style="margin-bottom: 5px;">${sentence.trim()}.</li>`;
                });
            }
            summary += `</ul>`;
            
            // Generate action items
            summary += `<h4 style="margin-top: 15px; margin-bottom: 10px; color: #667eea;">‚úÖ Action Items</h4><ul style="margin-left: 20px;">`;
            
            // Smart action item detection
            const actionItems = [];
            
            if (status === 'Filed') {
                actionItems.push('Schedule Level 1 meeting with administration');
                actionItems.push('Gather supporting documentation');
            }
            else if (status === 'Investigation') {
                actionItems.push('Follow up on investigation progress');
                actionItems.push('Prepare evidence and witness statements');
            }
            else if (status === 'Mediation') {
                actionItems.push('Prepare mediation strategy');
                actionItems.push('Document all mediation discussions');
            }
            else if (status === 'Arbitration') {
                actionItems.push('Coordinate with legal counsel');
                actionItems.push('Prepare arbitration brief');
            }
            else if (status === 'Resolved') {
                actionItems.push('Document resolution terms');
                actionItems.push('Ensure compliance with agreed remedy');
                if (grievance && grievance.resolutionSummary) {
                    actionItems.push('Monitor ongoing compliance');
                }
            }
            
            // Check for remedy-related action items
            if (notes.toLowerCase().includes('remedy')) {
                actionItems.push('Monitor implementation of remedy');
            }
            
            // Check for meeting-related items
            if (description.toLowerCase().includes('meeting') || notes.toLowerCase().includes('meeting')) {
                actionItems.push('Track meeting schedule compliance');
            }
            
            // Add timeline tracking
            if (grievance && grievance.activityLog && grievance.activityLog.length > 2) {
                const daysSinceFiled = Math.floor((new Date() - new Date(grievance.dateFiled)) / (1000 * 60 * 60 * 24));
                if (daysSinceFiled > 30 && status !== 'Resolved') {
                    actionItems.push(`Case is ${daysSinceFiled} days old - consider escalation timeline`);
                }
            }
            
            actionItems.forEach(item => {
                summary += `<li style="margin-bottom: 5px;">${item}</li>`;
            });
            
            summary += `</ul>`;
            
            // Next steps based on priority
            if (priority === 'High') {
                summary += `<div style="margin-top: 15px; padding: 10px; background: #fee2e2; border-left: 3px solid #dc2626; border-radius: 4px;"><strong>‚ö†Ô∏è High Priority:</strong> Immediate action required. Follow up within 48 hours.</div>`;
            }
            
            // Add case analysis if activity log exists
            if (grievance && grievance.activityLog && grievance.activityLog.length > 1) {
                const updates = grievance.activityLog.length - 1;
                summary += `<div style="margin-top: 15px; padding: 10px; background: #e0e7ff; border-left: 3px solid #667eea; border-radius: 4px;"><strong>üìà Case Activity:</strong> ${updates} update${updates > 1 ? 's' : ''} recorded. ${status === 'Resolved' ? 'Case successfully resolved.' : 'Case in progress.'}</div>`;
            }
            
            return summary;
        }

        function deleteGrievance(id) {
            if (confirm('Are you sure you want to delete this grievance?')) {
                grievances = grievances.filter(g => g.id !== id);
                saveData();
                renderGrievances();
                updateStats();
            }
        }

        function viewGrievance(id) {
            const grievance = grievances.find(g => g.id === id);
            if (!grievance) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.zIndex = '1001';
            
            let activityLogHTML = '';
            if (grievance.activityLog && grievance.activityLog.length > 0) {
                activityLogHTML = `
                    <h3 style="margin-top: 25px; margin-bottom: 15px; color: #667eea;">üìã Activity Timeline</h3>
                    <div style="background: #f8f9fa; border-radius: 6px; padding: 15px; max-height: 300px; overflow-y: auto;">
                        ${grievance.activityLog.map(entry => `
                            <div style="padding: 10px; background: white; border-radius: 4px; margin-bottom: 8px; border-left: 3px solid #667eea;">
                                <div style="display: flex; justify-content: space-between;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #333;">${entry.action}</div>
                                        <div style="color: #666; font-size: 14px; margin-top: 4px;">${entry.details}</div>
                                    </div>
                                    <div style="color: #999; font-size: 12px; white-space: nowrap; margin-left: 10px;">${formatDate(entry.date)}</div>
                                </div>
                            </div>
                        `).reverse().join('')}
                    </div>
                `;
            }
            
            let filesHTML = '';
            if (grievance.files && grievance.files.length > 0) {
                filesHTML = `
                    <h3 style="margin-top: 25px; margin-bottom: 15px; color: #667eea;">üìé Attachments (${grievance.files.length})</h3>
                    <div style="background: #f8f9fa; border-radius: 6px; padding: 15px;">
                        ${grievance.files.map((file, index) => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 4px; margin-bottom: 8px;">
                                <span>üìÑ ${file.name} (${formatFileSize(file.size)})</span>
                                <button class="btn btn-info" onclick="downloadFileFromGrievance(${id}, ${index})">Download</button>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            let resolutionHTML = '';
            if (grievance.resolutionDate || grievance.resolutionMethod || grievance.resolutionSummary || (grievance.resolutionFiles && grievance.resolutionFiles.length > 0)) {
                resolutionHTML = `
                    <div style="background: #d1fae5; border: 2px solid #10b981; border-radius: 8px; padding: 20px; margin-top: 25px;">
                        <h3 style="margin-bottom: 15px; color: #065f46;">‚úÖ Resolution Details</h3>
                        ${grievance.resolutionDate ? `<p style="margin-bottom: 10px;"><strong>Resolution Date:</strong> ${formatDate(grievance.resolutionDate)}</p>` : ''}
                        ${grievance.resolutionMethod ? `<p style="margin-bottom: 10px;"><strong>Method:</strong> ${grievance.resolutionMethod}</p>` : ''}
                        ${grievance.resolutionSummary ? `
                            <p style="margin-bottom: 10px;"><strong>Summary:</strong></p>
                            <div style="background: white; padding: 15px; border-radius: 6px; white-space: pre-line; margin-bottom: 15px;">${grievance.resolutionSummary}</div>
                        ` : ''}
                        ${grievance.resolutionFiles && grievance.resolutionFiles.length > 0 ? `
                            <p style="margin-bottom: 10px;"><strong>Resolution Documents (${grievance.resolutionFiles.length}):</strong></p>
                            <div>
                                ${grievance.resolutionFiles.map((file, index) => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 4px; margin-bottom: 8px;">
                                        <span>üìÑ ${file.name} (${formatFileSize(file.size)})</span>
                                        <button class="btn btn-info" onclick="downloadResolutionFileFromGrievance(${id}, ${index})">Download</button>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h2>Grievance #${grievance.id} - ${grievance.grievant}</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 15px;">
                            <div>
                                <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">${grievance.issue}</div>
                                <div style="opacity: 0.9;">Filed: ${formatDate(grievance.dateFiled)}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="margin-bottom: 5px;">
                                    <span style="background: rgba(255,255,255,0.3); padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: 600; text-transform: uppercase;">${grievance.status}</span>
                                </div>
                                <div>
                                    <span style="background: rgba(255,255,255,0.3); padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: 600;">${grievance.priority} Priority</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="template-section" style="background: #fef3c7; border-color: #f59e0b; margin-bottom: 20px;">
                        <h3>ü§ñ AI Summary & Action Items</h3>
                        <p style="margin-bottom: 10px; color: #666; font-size: 14px;">Generate an intelligent summary and identify action items from this grievance.</p>
                        <button class="btn btn-info" onclick="generateSummaryForView(${id})">Generate Summary</button>
                        <div id="viewSummaryOutput-${id}" style="margin-top: 10px; display: none; background: white; padding: 15px; border-radius: 6px; border: 1px solid #e0e0e0;"></div>
                    </div>
                    
                    <div style="line-height: 1.6;">
                        ${grievance.description ? `
                            <h3 style="margin-bottom: 10px; color: #667eea;">Description</h3>
                            <p style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">${grievance.description}</p>
                        ` : ''}
                        
                        ${grievance.notes ? `
                            <h3 style="margin-bottom: 10px; color: #667eea;">Notes</h3>
                            <p style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px; white-space: pre-line;">${grievance.notes}</p>
                        ` : ''}
                        
                        ${grievance.nextActionDate ? `
                            <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                                <strong>‚è∞ Next Action Date:</strong> ${formatDate(grievance.nextActionDate)}
                            </div>
                        ` : ''}
                        
                        ${activityLogHTML}
                        ${resolutionHTML}
                        ${filesHTML}
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                        <button class="btn btn-edit" onclick="this.closest('.modal').remove(); openModal(${id});">Edit Grievance</button>
                        <button class="btn btn-primary" onclick="this.closest('.modal').remove()">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close on outside click
            modal.onclick = function(event) {
                if (event.target === modal) {
                    modal.remove();
                }
            };
        }

        function viewGrievanceFiles(id) {
            const grievance = grievances.find(g => g.id === id);
            if (grievance && grievance.files && grievance.files.length > 0) {
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Files for Grievance #${id}</h2>
                            <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <div class="file-list">
                            ${grievance.files.map((file, index) => `
                                <div class="file-item">
                                    <span class="file-item-name">üìé ${file.name} (${formatFileSize(file.size)})</span>
                                    <button class="btn btn-info" onclick="downloadFileFromGrievance(${id}, ${index})">Download</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } else {
                alert('No files attached to this grievance.');
            }
        }

        function downloadFileFromGrievance(grievanceId, fileIndex) {
            const grievance = grievances.find(g => g.id === grievanceId);
            if (grievance && grievance.files[fileIndex]) {
                const file = grievance.files[fileIndex];
                const link = document.createElement('a');
                link.href = file.data;
                link.download = file.name;
                link.click();
            }
        }

        function downloadResolutionFileFromGrievance(grievanceId, fileIndex) {
            const grievance = grievances.find(g => g.id === grievanceId);
            if (grievance && grievance.resolutionFiles && grievance.resolutionFiles[fileIndex]) {
                const file = grievance.resolutionFiles[fileIndex];
                const link = document.createElement('a');
                link.href = file.data;
                link.download = file.name;
                link.click();
            }
        }

        function generateDocument(templateType) {
            const grievant = document.getElementById('grievant').value || '[Grievant Name]';
            const dateFiled = document.getElementById('dateFiled').value || '[Date]';
            const issue = document.getElementById('issue').value || '[Issue]';
            const description = document.getElementById('description').value || '[Description]';
            const status = document.getElementById('status').value;
            const priority = document.getElementById('priority').value;
            const notes = document.getElementById('notes').value || '[No additional notes]';

            let documentContent = '';
            let fileName = '';

            switch(templateType) {
                case 'basic':
                    fileName = `Grievance_Form_${grievant.replace(/\s+/g, '_')}.txt`;
                    documentContent = `
GRIEVANCE FORM

Date Filed: ${dateFiled}
Grievant Name: ${grievant}
Issue/Contract Violation: ${issue}

Description of Grievance:
${description}

Current Status: ${status}
Priority Level: ${priority}

Additional Notes:
${notes}

Signature: _______________________
Date: _______________________
                    `;
                    break;

                case 'formal':
                    fileName = `Formal_Grievance_${grievant.replace(/\s+/g, '_')}.txt`;
                    documentContent = `
FORMAL GRIEVANCE LETTER

Date: ${dateFiled}

To: [Administration/Supervisor Name]
From: ${grievant}
Re: Formal Grievance - ${issue}

I am writing to file a formal grievance regarding the following matter:

VIOLATION:
${issue}

DESCRIPTION:
${description}

REMEDY SOUGHT:
[Please specify the remedy you are seeking]

This grievance is filed in accordance with the collective bargaining agreement and should be processed according to the established grievance procedure.

I request a response to this grievance within the timeframe specified in the contract.

Respectfully submitted,

_______________________
${grievant}
Date: ${dateFiled}

Union Representative: _______________________
Date: _______________________

Priority: ${priority}
Current Status: ${status}

Additional Notes:
${notes}
                    `;
                    break;

                case 'appeal':
                    fileName = `Grievance_Appeal_${grievant.replace(/\s+/g, '_')}.txt`;
                    documentContent = `
GRIEVANCE APPEAL FORM

Date of Appeal: ${dateFiled}
Grievant: ${grievant}
Original Issue: ${issue}

GROUNDS FOR APPEAL:
${description}

PREVIOUS DECISION:
[Summarize the previous decision being appealed]

REASON FOR APPEAL:
[Explain why the decision should be overturned or reconsidered]

REQUESTED REMEDY:
[Specify what remedy is being sought on appeal]

Supporting Documentation: ${currentFiles.length > 0 ? 'See attached files' : 'None'}

Priority Level: ${priority}
Current Status: ${status}

Additional Notes:
${notes}

Grievant Signature: _______________________
Date: _______________________

Union Representative: _______________________
Date: _______________________
                    `;
                    break;
            }

            // Create and download the document
            const blob = new Blob([documentContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            link.click();
            URL.revokeObjectURL(url);

            // Also add it to attachments
            const reader = new FileReader();
            reader.onload = function(e) {
                currentFiles.push({
                    name: fileName,
                    type: 'text/plain',
                    size: blob.size,
                    data: e.target.result
                });
                renderFileList();
            };
            reader.readAsDataURL(blob);
        }

        function openTemplateManager() {
            document.getElementById('templateModal').classList.add('active');
            renderTemplateList();
        }

        function closeTemplateModal() {
            document.getElementById('templateModal').classList.remove('active');
        }

        function handleTemplateUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    templates.push({
                        name: file.name,
                        data: e.target.result
                    });
                    saveData();
                    renderTemplateList();
                    alert('Template uploaded successfully!');
                };
                reader.readAsDataURL(file);
            }
        }

        function renderTemplateList() {
            const templateList = document.getElementById('templateList');
            if (templates.length === 0) {
                templateList.innerHTML = '<p style="color: #666;">No custom templates uploaded yet.</p>';
                return;
            }

            templateList.innerHTML = templates.map((template, index) => `
                <div class="file-item">
                    <span class="file-item-name">üìÑ ${template.name}</span>
                    <div class="file-item-actions">
                        <button class="btn btn-info" onclick="downloadTemplate(${index})">Download</button>
                        <button class="btn btn-danger" onclick="deleteTemplate(${index})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function downloadTemplate(index) {
            const template = templates[index];
            const link = document.createElement('a');
            link.href = template.data;
            link.download = template.name;
            link.click();
        }

        function deleteTemplate(index) {
            if (confirm('Delete this template?')) {
                templates.splice(index, 1);
                saveData();
                renderTemplateList();
            }
        }

        function filterGrievances() {
            const statusFilter = document.getElementById('statusFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            const filtered = grievances.filter(g => {
                const matchesStatus = statusFilter === 'all' || g.status === statusFilter;
                const matchesPriority = priorityFilter === 'all' || g.priority === priorityFilter;
                const matchesSearch = searchTerm === '' || 
                    g.grievant.toLowerCase().includes(searchTerm) ||
                    g.issue.toLowerCase().includes(searchTerm) ||
                    (g.description && g.description.toLowerCase().includes(searchTerm));
                
                return matchesStatus && matchesPriority && matchesSearch;
            });

            renderGrievances(filtered);
        }

        function renderGrievances(filteredGrievances = null) {
            const tbody = document.getElementById('grievanceBody');
            const emptyState = document.getElementById('emptyState');
            const displayGrievances = filteredGrievances || grievances;

            tbody.innerHTML = '';

            if (displayGrievances.length === 0) {
                emptyState.style.display = 'block';
                document.getElementById('grievanceTable').style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            document.getElementById('grievanceTable').style.display = 'table';

            const sortedGrievances = [...displayGrievances].sort((a, b) => 
                new Date(b.dateFiled) - new Date(a.dateFiled)
            );

            sortedGrievances.forEach(g => {
                const fileCount = g.files ? g.files.length : 0;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>#${g.id}</strong></td>
                    <td>${formatDate(g.dateFiled)}</td>
                    <td>${g.grievant}</td>
                    <td>${g.issue}</td>
                    <td><span class="status-badge status-${g.status.toLowerCase()}">${g.status}</span></td>
                    <td><span class="priority-${g.priority.toLowerCase()}">${g.priority}</span></td>
                    <td>
                        ${fileCount > 0 ? `<span class="attachment-badge">${fileCount} file${fileCount > 1 ? 's' : ''}</span>` : '-'}
                    </td>
                    <td class="action-buttons">
                        <button class="btn btn-view" onclick="viewGrievance(${g.id})">View</button>
                        ${fileCount > 0 ? `<button class="btn btn-view" onclick="viewGrievanceFiles(${g.id})">Files</button>` : ''}
                        <button class="btn btn-edit" onclick="openModal(${g.id})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteGrievance(${g.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateStats() {
            const total = grievances.length;
            const open = grievances.filter(g => !['Resolved', 'Withdrawn'].includes(g.status)).length;
            const resolved = grievances.filter(g => g.status === 'Resolved').length;
            const arbitration = grievances.filter(g => g.status === 'Arbitration').length;

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-open').textContent = open;
            document.getElementById('stat-resolved').textContent = resolved;
            document.getElementById('stat-escalated').textContent = arbitration;
        }

        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function exportToCSV() {
            if (grievances.length === 0) {
                alert('No grievances to export!');
                return;
            }

            const headers = ['ID', 'Date Filed', 'Grievant', 'Issue', 'Description', 'Status', 'Priority', 'Next Action Date', 'Notes', 'File Count'];
            const rows = grievances.map(g => [
                g.id,
                g.dateFiled,
                g.grievant,
                g.issue,
                g.description || '',
                g.status,
                g.priority,
                g.nextActionDate || '',
                g.notes || '',
                g.files ? g.files.length : 0
            ]);

            let csvContent = headers.join(',') + '\n';
            rows.forEach(row => {
                csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `grievances_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        window.onclick = function(event) {
            const grievanceModal = document.getElementById('grievanceModal');
            const templateModal = document.getElementById('templateModal');
            const libraryModal = document.getElementById('libraryModal');
            if (event.target === grievanceModal) {
                closeModal();
            }
            if (event.target === templateModal) {
                closeTemplateModal();
            }
            if (event.target === libraryModal) {
                closeLibraryModal();
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Activate the clicked button
            const buttons = document.querySelectorAll('.nav-tab');
            buttons.forEach((btn, index) => {
                if ((index === 0 && tabName === 'grievances') ||
                    (index === 1 && tabName === 'library') ||
                    (index === 2 && tabName === 'journal')) {
                    btn.classList.add('active');
                }
            });
            
            // Load content if needed
            if (tabName === 'library') {
                renderLibrary();
            } else if (tabName === 'journal') {
                generateJournalReport();
            }
        }

        // Library Management
        function loadLibraryData() {
            const saved = localStorage.getItem('libraryDocuments');
            if (saved) {
                libraryDocuments = JSON.parse(saved);
                libraryNextId = Math.max(...libraryDocuments.map(d => d.id), 0) + 1;
            }
        }

        function saveLibraryData() {
            localStorage.setItem('libraryDocuments', JSON.stringify(libraryDocuments));
        }

        function openLibraryModal(id = null) {
            const modal = document.getElementById('libraryModal');
            const form = document.getElementById('libraryForm');
            
            form.reset();
            currentLibraryFile = null;
            document.getElementById('libraryFilePreview').innerHTML = '';
            
            if (id !== null) {
                const doc = libraryDocuments.find(d => d.id === id);
                if (doc) {
                    document.getElementById('libraryModalTitle').textContent = 'Edit Library Document';
                    document.getElementById('libraryEditId').value = doc.id;
                    document.getElementById('libraryDocType').value = doc.type;
                    document.getElementById('libraryDocName').value = doc.name;
                    document.getElementById('libraryDocDate').value = doc.effectiveDate || '';
                    document.getElementById('libraryDocArticles').value = doc.articles || '';
                    document.getElementById('libraryDocNotes').value = doc.notes || '';
                    
                    if (doc.file) {
                        currentLibraryFile = doc.file;
                        document.getElementById('libraryFilePreview').innerHTML = `
                            <div class="file-item">
                                <span>üìÑ ${doc.file.name}</span>
                            </div>
                        `;
                    }
                }
            } else {
                document.getElementById('libraryModalTitle').textContent = 'Add Document to Library';
            }
            
            modal.classList.add('active');
        }

        function closeLibraryModal() {
            document.getElementById('libraryModal').classList.remove('active');
        }

        function handleLibraryFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentLibraryFile = {
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result
                    };
                    document.getElementById('libraryFilePreview').innerHTML = `
                        <div class="file-item">
                            <span>üìÑ ${file.name} (${formatFileSize(file.size)})</span>
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            }
        }

        function saveLibraryDocument(event) {
            event.preventDefault();
            
            if (!currentLibraryFile) {
                alert('Please upload a document file');
                return;
            }
            
            const editId = document.getElementById('libraryEditId').value;
            
            const document = {
                id: editId ? parseInt(editId) : libraryNextId++,
                type: document.getElementById('libraryDocType').value,
                name: document.getElementById('libraryDocName').value,
                effectiveDate: document.getElementById('libraryDocDate').value,
                articles: document.getElementById('libraryDocArticles').value,
                notes: document.getElementById('libraryDocNotes').value,
                file: currentLibraryFile,
                dateAdded: editId ? libraryDocuments.find(d => d.id === parseInt(editId)).dateAdded : new Date().toISOString().split('T')[0]
            };

            if (editId) {
                const index = libraryDocuments.findIndex(d => d.id === parseInt(editId));
                libraryDocuments[index] = document;
            } else {
                libraryDocuments.push(document);
            }

            saveLibraryData();
            renderLibrary();
            closeLibraryModal();
        }

        function filterLibrary() {
            const typeFilter = document.getElementById('libraryTypeFilter').value;
            const searchTerm = document.getElementById('librarySearch').value.toLowerCase();

            const filtered = libraryDocuments.filter(doc => {
                const matchesType = typeFilter === 'all' || doc.type === typeFilter;
                const matchesSearch = searchTerm === '' || 
                    doc.name.toLowerCase().includes(searchTerm) ||
                    (doc.articles && doc.articles.toLowerCase().includes(searchTerm)) ||
                    (doc.notes && doc.notes.toLowerCase().includes(searchTerm));
                
                return matchesType && matchesSearch;
            });

            renderLibrary(filtered);
        }

        function renderLibrary(filteredDocs = null) {
            const container = document.getElementById('libraryContainer');
            const displayDocs = filteredDocs || libraryDocuments;

            if (displayDocs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No Documents in Library</h3>
                        <p>Add your CBA, MOUs, and policies to cross-reference with grievances</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                    ${displayDocs.map(doc => `
                        <div style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 20px; background: white;">
                            <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 10px;">
                                <span style="background: #667eea; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">${doc.type}</span>
                            </div>
                            <h3 style="color: #333; margin-bottom: 10px; font-size: 16px;">${doc.name}</h3>
                            ${doc.effectiveDate ? `<p style="color: #666; font-size: 14px; margin-bottom: 8px;">üìÖ ${formatDate(doc.effectiveDate)}</p>` : ''}
                            ${doc.articles ? `<p style="color: #666; font-size: 14px; margin-bottom: 8px;">üìã ${doc.articles.split('\\n')[0]}${doc.articles.split('\\n').length > 1 ? '...' : ''}</p>` : ''}
                            <div style="display: flex; gap: 5px; margin-top: 15px;">
                                <button class="btn btn-view" onclick="downloadLibraryDoc(${doc.id})">Download</button>
                                <button class="btn btn-edit" onclick="openLibraryModal(${doc.id})">Edit</button>
                                <button class="btn btn-danger" onclick="deleteLibraryDoc(${doc.id})">Delete</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function downloadLibraryDoc(id) {
            const doc = libraryDocuments.find(d => d.id === id);
            if (doc && doc.file) {
                const link = document.createElement('a');
                link.href = doc.file.data;
                link.download = doc.file.name;
                link.click();
            }
        }

        function deleteLibraryDoc(id) {
            if (confirm('Delete this document from library?')) {
                libraryDocuments = libraryDocuments.filter(d => d.id !== id);
                saveLibraryData();
                renderLibrary();
            }
        }

        // Violation Journal
        function generateJournalReport() {
            const container = document.getElementById('journalContent');
            
            if (grievances.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No Grievances to Analyze</h3>
                        <p>Add grievances to generate violation patterns and analysis</p>
                    </div>
                `;
                return;
            }

            // Analyze grievances by article
            const violationsByArticle = {};
            grievances.forEach(g => {
                const article = g.issue.split('-')[0].trim();
                if (!violationsByArticle[article]) {
                    violationsByArticle[article] = {
                        count: 0,
                        resolved: 0,
                        pending: 0,
                        cases: []
                    };
                }
                violationsByArticle[article].count++;
                if (g.status === 'Resolved') {
                    violationsByArticle[article].resolved++;
                } else {
                    violationsByArticle[article].pending++;
                }
                violationsByArticle[article].cases.push(g);
            });

            let report = `
                <div style="background: white; border-radius: 8px; padding: 30px; border: 2px solid #e0e0e0;">
                    <h2 style="color: #667eea; margin-bottom: 20px;">Contract Violation Analysis</h2>
                    <p style="color: #666; margin-bottom: 30px;">Generated: ${new Date().toLocaleDateString()}</p>
            `;

            // Summary stats
            const totalResolved = grievances.filter(g => g.status === 'Resolved').length;
            const totalPending = grievances.length - totalResolved;
            const winRate = grievances.length > 0 ? ((totalResolved / grievances.length) * 100).toFixed(1) : 0;

            report += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                        <div style="font-size: 32px; font-weight: bold; color: #0369a1;">${grievances.length}</div>
                        <div style="color: #666;">Total Cases</div>
                    </div>
                    <div style="background: #d1fae5; padding: 20px; border-radius: 8px; border-left: 4px solid #10b981;">
                        <div style="font-size: 32px; font-weight: bold; color: #065f46;">${totalResolved}</div>
                        <div style="color: #666;">Resolved</div>
                    </div>
                    <div style="background: #fef3c7; padding: 20px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <div style="font-size: 32px; font-weight: bold; color: #92400e;">${totalPending}</div>
                        <div style="color: #666;">Pending</div>
                    </div>
                    <div style="background: #e0e7ff; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea;">
                        <div style="font-size: 32px; font-weight: bold; color: #4338ca;">${winRate}%</div>
                        <div style="color: #666;">Success Rate</div>
                    </div>
                </div>
            `;

            // Violations by article
            report += `
                <h3 style="color: #667eea; margin-bottom: 15px; margin-top: 30px;">Violations by Contract Article</h3>
                <div style="background: #f8f9fa; border-radius: 8px; padding: 20px;">
            `;

            Object.keys(violationsByArticle).sort((a, b) => violationsByArticle[b].count - violationsByArticle[a].count).forEach(article => {
                const data = violationsByArticle[article];
                const percentage = ((data.resolved / data.count) * 100).toFixed(0);
                
                report += `
                    <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #e0e0e0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="color: #333; margin: 0;">${article}</h4>
                            <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">${data.count} case${data.count > 1 ? 's' : ''}</span>
                        </div>
                        <div style="display: flex; gap: 20px; margin-bottom: 10px; color: #666; font-size: 14px;">
                            <span>‚úÖ Resolved: ${data.resolved}</span>
                            <span>‚è≥ Pending: ${data.pending}</span>
                            <span>üìä Success: ${percentage}%</span>
                        </div>
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: #667eea; font-weight: 600;">View Cases</summary>
                            <div style="margin-top: 10px; padding-left: 20px;">
                                ${data.cases.map(c => `
                                    <div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px;">
                                        <strong>${c.grievant}</strong> - ${formatDate(c.dateFiled)} 
                                        <span class="status-badge status-${c.status.toLowerCase()}">${c.status}</span>
                                        ${c.resolutionMethod ? `<br><small style="color: #666;">Resolved via ${c.resolutionMethod}</small>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </details>
                    </div>
                `;
            });

            report += `</div>`;

            // Patterns and recommendations
            report += `
                <h3 style="color: #667eea; margin-bottom: 15px; margin-top: 30px;">Patterns & Recommendations</h3>
                <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 20px; border-radius: 8px;">
                    <ul style="margin-left: 20px; line-height: 1.8;">
            `;

            // Find most common violation
            const mostCommon = Object.keys(violationsByArticle).reduce((a, b) => 
                violationsByArticle[a].count > violationsByArticle[b].count ? a : b
            );
            report += `<li><strong>Most Common Violation:</strong> ${mostCommon} (${violationsByArticle[mostCommon].count} cases) - Consider training or policy clarification</li>`;

            // Check for repeat violations
            const repeatViolations = Object.keys(violationsByArticle).filter(k => violationsByArticle[k].count > 2);
            if (repeatViolations.length > 0) {
                report += `<li><strong>Systemic Issues:</strong> ${repeatViolations.length} article(s) with multiple violations - Recommend systemic approach</li>`;
            }

            // Success rate analysis
            if (winRate > 80) {
                report += `<li><strong>Strong Track Record:</strong> ${winRate}% success rate demonstrates effective contract enforcement</li>`;
            } else if (winRate < 50) {
                report += `<li><strong>Strategy Review Needed:</strong> ${winRate}% success rate suggests need for case strategy refinement</li>`;
            }

            report += `
                    </ul>
                </div>
            `;

            report += `</div>`;

            container.innerHTML = report;
        }

        function exportJournalToPDF() {
            alert('PDF export functionality would integrate with a PDF library. For now, use your browser\\'s Print > Save as PDF feature.');
            window.print();
        }

        loadData();
        loadLibraryData();
    </script>
</body>
</html>
